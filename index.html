<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>执念清除计划 — 集成版</title>
    <style>
        /* ---------- 基础样式 (基于空白15.txt) ---------- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        
        body {
            background-color: #000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* 手机容器 */
        #phone-container {
            width: 375px;
            height: 812px;
            background-color: #000;
            border-radius: 40px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 0 50px rgba(255, 255, 255, 0.1);
            border: 10px solid #333;
        }
        
        /* 状态栏 */
        #status-bar {
            height: 44px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 14px;
            font-weight: 600;
        }
        
        /* 主屏幕 */
        #home-screen {
            height: calc(100% - 44px);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-size: cover;
            background-position: center;
            position: relative;
            overflow: hidden;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        /* 应用网格 */
        #app-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-top: 100px;
        }
        
        .app-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .app-icon:active {
            transform: scale(0.9);
        }
        
        .app-icon-bg {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 8px;
            font-size: 24px;
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        
        .app-label {
            font-size: 12px;
            color: white;
            text-align: center;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        /* 屏幕容器 */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f2f2f7;
            z-index: 10;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        
        .screen.active {
            display: flex;
        }
        
        /* 屏幕头部 */
        .screen-header {
            height: 44px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid #e5e5ea;
            position: relative;
            z-index: 100;
        }
        
        .screen-title {
            font-size: 17px;
            font-weight: 600;
            color: #000;
        }
        
        .back-btn {
            font-size: 16px;
            color: #007aff;
            cursor: pointer;
            padding: 10px 0;
            min-width: 50px;
        }
        
        /* 屏幕内容 */
        .screen-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background-color: #f2f2f7;
        }
        
        /* 底部导航栏 */
        #dock {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-around;
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 10px;
        }
        
        .dock-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            color: white;
            cursor: pointer;
        }
        
        /* ========== 角色库样式 ========== */
        .character-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .character-card {
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .character-card:active {
            transform: scale(0.95);
        }
        
        .character-avatar {
            width: 100%;
            height: 120px;
            background-color: #6e8efb;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            color: white;
        }
        
        .character-info {
            padding: 10px;
        }
        
        .character-name {
            font-size: 16px;
            font-weight: 600;
            color: #000;
            margin-bottom: 5px;
        }
        
        .character-desc {
            font-size: 12px;
            color: #8e8e93;
        }
        
        /* ========== 设置样式 ========== */
        .settings-section {
            background-color: white;
            border-radius: 10px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e5e5ea;
            cursor: pointer;
        }
        
        .settings-item:last-child {
            border-bottom: none;
        }
        
        .settings-label {
            font-size: 16px;
            color: #000;
        }
        
        .settings-value {
            font-size: 16px;
            color: #8e8e93;
        }
        
        .toggle-switch {
            position: relative;
            width: 51px;
            height: 31px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e5e5ea;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 27px;
            width: 27px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #34c759;
        }
        
        input:checked + .slider:before {
            transform: translateX(20px);
        }
        
        /* ========== API设置样式 ========== */
        .form-container {
            padding: 15px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-size: 16px;
            color: #000;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #e5e5ea;
            border-radius: 8px;
            font-size: 16px;
            background-color: white;
        }
        
        .form-button {
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        
        .form-button-secondary {
            background-color: #f2f2f7;
            color: #007aff;
            border: 1px solid #007aff;
        }
        
        hr {
            margin: 30px 0;
            border: none;
            border-top: 1px solid #e5e5ea;
        }
        
        /* ========== 壁纸设置样式 ========== */
        .wallpaper-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .wallpaper-item {
            aspect-ratio: 3/5;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .wallpaper-item.active {
            border-color: #007aff;
        }
        
        .wallpaper-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* ========== 商城样式 (淘宝风格) ========== */
        .shop-header {
            background-color: #ff5000;
            color: white;
            padding: 10px 15px;
        }
        
        .shop-search {
            display: flex;
            align-items: center;
            background: white;
            border-radius: 20px;
            padding: 8px 15px;
            margin-bottom: 10px;
        }
        
        .shop-search input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 14px;
            margin-left: 8px;
        }
        
        .shop-categories {
            display: flex;
            overflow-x: auto;
            padding: 10px 0;
            gap: 15px;
        }
        
        .shop-category {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 60px;
        }
        
        .shop-category-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .shop-category-name {
            font-size: 12px;
            color: white;
        }
        
        .shop-banner {
            width: 100%;
            height: 120px;
            background: linear-gradient(45deg, #ff6b6b, #ffa726);
            border-radius: 10px;
            margin: 15px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 18px;
            font-weight: bold;
        }
        
        .shop-products {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .shop-product {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .shop-product-image {
            width: 100%;
            height: 120px;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
        }
        
        .shop-product-info {
            padding: 10px;
        }
        
        .shop-product-name {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 5px;
            color: #333;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .shop-product-price {
            font-size: 16px;
            font-weight: bold;
            color: #ff5000;
            margin-bottom: 8px;
        }
        
        .shop-product-buy {
            background-color: #ff5000;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            width: 100%;
        }
        
        .shop-tab-bar {
            display: flex;
            background-color: white;
            border-top: 1px solid #e5e5ea;
            position: sticky;
            bottom: 0;
        }
        
        .shop-tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            font-size: 12px;
            color: #666;
        }
        
        .shop-tab.active {
            color: #ff5000;
        }
        
        /* ========== 论坛样式 (豆瓣风格) ========== */
        .forum-header {
            background-color: #2e963d;
            color: white;
            padding: 10px 15px;
        }
        
        .forum-tabs {
            display: flex;
            overflow-x: auto;
            padding: 10px 0;
            gap: 20px;
        }
        
        .forum-tab {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.7);
            white-space: nowrap;
            padding-bottom: 5px;
        }
        
        .forum-tab.active {
            color: white;
            border-bottom: 2px solid white;
        }
        
        .forum-post {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .forum-post-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .forum-post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            background-color: #2e963d;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            color: white;
            margin-right: 10px;
        }
        
        .forum-post-info {
            flex: 1;
        }
        
        .forum-post-author {
            font-size: 16px;
            font-weight: 500;
            color: #333;
            margin-bottom: 2px;
        }
        
        .forum-post-time {
            font-size: 12px;
            color: #999;
        }
        
        .forum-post-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        
        .forum-post-content {
            font-size: 15px;
            color: #666;
            line-height: 1.4;
            margin-bottom: 10px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .forum-post-image {
            width: 100%;
            height: 150px;
            background-color: #f0f0f0;
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            color: #ccc;
        }
        
        .forum-post-stats {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: #999;
        }
        
        .forum-new-post {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 50px;
            height: 50px;
            background-color: #2e963d;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 100;
        }
        
        /* ========== 游戏界面样式 ========== */
        .game-container {
            background-color: #1c1c1e;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .game-header {
            padding: 15px;
            background-color: #2c2c2e;
            border-bottom: 1px solid #38383a;
        }
        
        .game-title {
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .game-stats {
            display: flex;
            justify-content: space-around;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 16px;
            font-weight: 600;
            color: #6e8efb;
        }
        
        .stat-label {
            font-size: 12px;
            color: #8e8e93;
        }
        
        .game-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }
        
        .dialogue-box {
            background-color: #2c2c2e;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .dialogue-speaker {
            font-size: 14px;
            font-weight: 600;
            color: #6e8efb;
            margin-bottom: 5px;
        }
        
        .dialogue-text {
            font-size: 16px;
            line-height: 1.4;
        }
        
        .choices-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .choice-btn {
            background-color: #3a3a3c;
            border: none;
            border-radius: 10px;
            padding: 15px;
            color: white;
            font-size: 16px;
            text-align: left;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .choice-btn:hover {
            background-color: #48484a;
        }
        
        .game-footer {
            padding: 15px;
            background-color: #2c2c2e;
            border-top: 1px solid #38383a;
        }
        
        .action-buttons {
            display: flex;
            justify-content: space-around;
        }
        
        .action-btn {
            background-color: #3a3a3c;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            color: white;
            cursor: pointer;
        }
        
        /* ========== 模态框样式 ========== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80%;
            overflow-y: auto;
            padding: 20px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e5e5ea;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #000;
        }
        
        .modal-close {
            font-size: 24px;
            color: #8e8e93;
            cursor: pointer;
        }
        
        .modal-body {
            color: #000;
        }
        
        /* 角色详情样式 */
        .character-detail {
            text-align: center;
        }
        
        .character-detail-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #6e8efb;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            color: white;
            margin: 0 auto 15px;
        }
        
        .character-detail-name {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #000;
        }
        
        .character-detail-desc {
            font-size: 16px;
            color: #8e8e93;
            margin-bottom: 20px;
        }
        
        .character-detail-info {
            text-align: left;
            background-color: #f2f2f7;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .character-detail-info h3 {
            font-size: 16px;
            color: #000;
            margin-bottom: 10px;
        }
        
        .character-detail-info p {
            font-size: 14px;
            color: #000;
            line-height: 1.4;
            margin-bottom: 10px;
        }
        
        /* 创建角色表单样式 */
        .create-character-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .form-row {
            display: flex;
            gap: 10px;
        }
        
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        /* 隐藏的文件输入 */
        #import-card-input {
            display: none;
        }
        
        /* ========== 世界选择样式 (基于空白17.txt) ========== */
        .world-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 8px;
        }
        
        .world-item {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #eee;
            background: #fafafa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .btn {
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
        }
        
        .btn.primary {
            background: #007aff;
            color: #fff;
        }
        
        .btn.ghost {
            background: #f2f2f7;
            color: #007aff;
            border: 1px solid #dcdcdc;
        }
        
        .small-muted {
            font-size: 12px;
            color: #888;
            margin-top: 6px;
        }
        
        /* 个人信息 / 排行榜 */
        .profile {
            padding: 12px;
            background: #fff;
            border-radius: 12px;
            margin: 12px;
        }
        
        .profile .row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }
        
        .profile .row:last-child {
            border-bottom: none;
        }
        
        .leaderboard {
            padding: 12px;
            background: #fff;
            border-radius: 12px;
            margin: 12px;
        }
        
        /* 结算报告样式 */
        .report-container {
            background: #fffef7;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e6d9b5;
            margin: 10px;
        }
        
        .completed {
            color: #8a9a5b;
            font-weight: bold;
            background-color: rgba(138, 154, 91, 0.1);
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .not-completed {
            color: #b5651d;
            font-weight: bold;
            background-color: rgba(181, 101, 29, 0.1);
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        /* 世界创建模态框 */
        #world-modal {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 92%;
            max-width: 420px;
            background: #fff;
            border-radius: 12px;
            color: #000;
            z-index: 120;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        
        #world-modal.visible {
            display: flex;
        }
        
        .modal-header {
            padding: 12px;
            border-bottom: 1px solid #eee;
            font-weight: 700;
        }
        
        .modal-body {
            padding: 12px;
            overflow: auto;
            max-height: 60vh;
        }
        
        .modal-footer {
            padding: 12px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <div id="phone-container">
        <!-- 状态栏 -->
        <div id="status-bar">
            <div id="status-time">12:00</div>
            <div>执念清除计划</div>
            <div id="status-points">积分: 0</div>
        </div>
        
        <!-- 主屏幕 -->
        <div id="home-screen" class="screen active">
            <!-- 时钟 -->
            <div id="clock-container" style="color: #fff; text-align: center; margin-top: 20px;">
                <div id="main-time" style="font-size: 56px; font-weight: 600;">00:00</div>
                <div class="small-muted">欢迎回归，宿主</div>
            </div>
            
            <!-- 应用网格 -->
            <div id="app-grid">
                <!-- 角色库 -->
                <div class="app-icon" data-screen="character-screen">
                    <div class="app-icon-bg">👥</div>
                    <div class="app-label">角色库</div>
                </div>
                
                <!-- 设置 -->
                <div class="app-icon" data-screen="settings-screen">
                    <div class="app-icon-bg">⚙️</div>
                    <div class="app-label">设置</div>
                </div>
                
                <!-- 继续游戏 -->
                <div class="app-icon" data-screen="game-screen">
                    <div class="app-icon-bg">▶️</div>
                    <div class="app-label">继续游戏</div>
                </div>
                
                <!-- 存读档 -->
                <div class="app-icon" data-screen="save-screen">
                    <div class="app-icon-bg">💾</div>
                    <div class="app-label">存读档</div>
                </div>
                
                <!-- 商城 -->
                <div class="app-icon" data-screen="shop-screen">
                    <div class="app-icon-bg">🛒</div>
                    <div class="app-label">商城</div>
                </div>
                
                <!-- 论坛 -->
                <div class="app-icon" data-screen="forum-screen">
                    <div class="app-icon-bg">💬</div>
                    <div class="app-label">论坛</div>
                </div>
                
                <!-- 快穿世界剧情 -->
                <div class="app-icon" data-screen="worlds-screen">
                    <div class="app-icon-bg">🌍</div>
                    <div class="app-label">世界剧情</div>
                </div>
                
                <!-- 个人信息 -->
                <div class="app-icon" data-screen="profile-screen">
                    <div class="app-icon-bg">👤</div>
                    <div class="app-label">个人信息</div>
                </div>
            </div>
            
            <!-- 底部导航栏 -->
            <div id="dock">
                <div class="dock-icon">📞</div>
                <div class="dock-icon">✉️</div>
                <div class="dock-icon">🌐</div>
                <div class="dock-icon">🎵</div>
            </div>
        </div>
        
        <!-- 角色库屏幕 -->
        <div id="character-screen" class="screen">
            <div class="screen-header">
                <div class="back-btn" data-back="home-screen">返回</div>
                <div class="screen-title">角色库</div>
                <div class="back-btn" id="add-character-btn">添加</div>
            </div>
            <div class="screen-content">
                <div class="character-grid">
                    <!-- 角色卡片会通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
        
        <!-- 设置屏幕 -->
        <div id="settings-screen" class="screen">
            <div class="screen-header">
                <div class="back-btn" data-back="home-screen">返回</div>
                <div class="screen-title">设置</div>
                <div></div>
            </div>
            <div class="screen-content">
                <div class="settings-section">
                    <div class="settings-item" data-screen="api-screen">
                        <div class="settings-label">API设置</div>
                        <div class="settings-value">></div>
                    </div>
                    <div class="settings-item" data-screen="wallpaper-screen">
                        <div class="settings-label">壁纸设置</div>
                        <div class="settings-value">></div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-label">音效</div>
                        <div class="toggle-switch">
                            <input type="checkbox" checked>
                            <span class="slider"></span>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-label">背景音乐</div>
                        <div class="toggle-switch">
                            <input type="checkbox" checked>
                            <span class="slider"></span>
                        </div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <div class="settings-item">
                        <div class="settings-label">游戏模式</div>
                        <div class="settings-value">全年龄向</div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-label">语言</div>
                        <div class="settings-value">简体中文</div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <div class="settings-item">
                        <div class="settings-label">关于游戏</div>
                        <div class="settings-value">版本 1.0.0</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- API设置屏幕 -->
        <div id="api-screen" class="screen">
            <div class="screen-header">
                <div class="back-btn" data-back="settings-screen">返回</div>
                <div class="screen-title">API设置</div>
                <div></div>
            </div>
            <div class="form-container">
                <!-- API预设管理 -->
                <h3 style="margin-top:0; border-bottom: 1px solid #eee; padding-bottom: 10px;">API 预设管理</h3>
                <div class="form-group">
                    <label for="api-preset-select">选择或切换预设</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="api-preset-select" style="flex-grow: 1;"></select>
                        <button id="save-api-preset-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">保存</button>
                        <button id="delete-api-preset-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px; background-color: #ffebee; color: #d32f2f; border-color: #ffcdd2;">删除</button>
                    </div>
                </div>
                <hr style="margin: 30px 0; opacity: 0.3;">
                <!-- 主API设置 -->
                <h3 style="margin-top:0; border-bottom: 1px solid #eee; padding-bottom: 10px;">主API设置 (用于聊天)</h3>
                <p style="font-size: 14px; color: #666; background-color: #f0f0f0; padding: 10px; border-radius: 8px;"> 提示: 若要使用"发送图片"功能, 请务必选择支持Vision(视觉)的模型, 如<code style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4o</code>或<code
                        style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4-vision-preview</code>。 </p>
                <div class="form-group">
                    <label for="proxy-url">反代地址 (不需要添加/v1噢~)</label>
                    <input type="text" id="proxy-url" placeholder="例如: https://api.openai.com">
                </div>
                <div class="form-group">
                    <label for="api-key">密钥 (API Key)</label>
                    <input type="password" id="api-key" placeholder="sk-...">
                </div>
                <div class="form-group">
                    <label for="model-select">模型</label>
                    <select id="model-select"></select>
                </div>
                <button class="form-button" id="fetch-models-btn">拉取主模型</button>
                <!-- 副API设置 -->
                <hr style="margin: 30px 0; opacity: 0.3;">
                <h3 style="border-bottom: 1px solid #eee; padding-bottom: 10px;">副API设置 (用于总结长期记忆)</h3>
                <p style="font-size: 14px; color: #666; background-color: #f0f0f0; padding: 10px; border-radius: 8px;"> 您可以在此配置一个独立的、可能成本更低的API，专门用于后台的长期记忆总结任务，以节省主API的费用。如果留空，将默认使用主API进行总结。 </p>
                <div class="form-group">
                    <label for="secondary-proxy-url">副反代地址</label>
                    <input type="text" id="secondary-proxy-url" placeholder="例如: https://api.groq.com/openai">
                </div>
                <div class="form-group">
                    <label for="secondary-api-key">副密钥</label>
                    <input type="password" id="secondary-api-key" placeholder="gsk_...">
                </div>
                <div class="form-group">
                    <label for="secondary-model-select">副模型</label>
                    <select id="secondary-model-select"></select>
                </div>
                <button class="form-button form-button-secondary" id="fetch-secondary-models-btn">拉取副模型</button>
            </div>
        </div>
        
        <!-- 壁纸设置屏幕 -->
        <div id="wallpaper-screen" class="screen">
            <div class="screen-header">
                <div class="back-btn" data-back="settings-screen">返回</div>
                <div class="screen-title">壁纸设置</div>
                <div></div>
            </div>
            <div class="screen-content">
                <div class="wallpaper-grid">
                    <!-- 壁纸选项会通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
        
        <!-- 商城屏幕 -->
        <div id="shop-screen" class="screen">
            <div class="screen-header">
                <div class="back-btn" data-back="home-screen">返回</div>
                <div class="screen-title">商城</div>
                <div></div>
            </div>
            <div class="screen-content" style="padding: 0;">
                <div class="shop-header">
                    <div class="shop-search">
                        <span>🔍</span>
                        <input type="text" placeholder="搜索商品">
                    </div>
                    <div class="shop-categories">
                        <div class="shop-category">
                            <div class="shop-category-icon">💎</div>
                            <div class="shop-category-name">道具</div>
                        </div>
                        <div class="shop-category">
                            <div class="shop-category-icon">👕</div>
                            <div class="shop-category-name">服装</div>
                        </div>
                        <div class="shop-category">
                            <div class="shop-category-icon">🏠</div>
                            <div class="shop-category-name">家园</div>
                        </div>
                        <div class="shop-category">
                            <div class="shop-category-icon">🎁</div>
                            <div class="shop-category-name">礼包</div>
                        </div>
                        <div class="shop-category">
                            <div class="shop-category-icon">⭐</div>
                            <div class="shop-category-name">限定</div>
                        </div>
                    </div>
                </div>
                
                <div style="padding: 15px;">
                    <div class="shop-banner">限时特惠 - 全场5折起</div>
                    
                    <div class="shop-products" id="shop-products">
                        <!-- 商品由 JS 注入 -->
                    </div>
                </div>
                
                <!-- 底部标签栏 -->
                <div class="shop-tab-bar">
                    <div class="shop-tab active">首页</div>
                    <div class="shop-tab">分类</div>
                    <div class="shop-tab">购物车</div>
                    <div class="shop-tab">我的</div>
                </div>
            </div>
        </div>
        
        <!-- 论坛屏幕 -->
        <div id="forum-screen" class="screen">
            <div class="screen-header">
                <div class="back-btn" data-back="home-screen">返回</div>
                <div class="screen-title">论坛</div>
                <div></div>
            </div>
            <div class="screen-content" style="padding: 0;">
                <div class="forum-header">
                    <div class="forum-tabs">
                        <div class="forum-tab active">推荐</div>
                        <div class="forum-tab">热门</div>
                        <div class="forum-tab">剧情讨论</div>
                        <div class="forum-tab">角色交流</div>
                        <div class="forum-tab">攻略分享</div>
                        <div class="forum-tab">同人创作</div>
                    </div>
                </div>
                
                <div style="padding: 15px;">
                    <!-- 帖子内容会通过JavaScript动态生成 -->
                </div>
                
                <!-- 发帖按钮 -->
                <div class="forum-new-post">+</div>
            </div>
        </div>
        
        <!-- 游戏屏幕 -->
        <div id="game-screen" class="screen">
            <div class="screen-header">
                <div class="back-btn" data-back="home-screen">退出</div>
                <div class="screen-title">当前世界</div>
                <div id="game-screen-title" style="font-weight:600;color:#000">-</div>
            </div>
            <div class="game-container">
                <div class="game-header">
                    <div class="game-title">执念清除计划</div>
                    <div class="game-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="stat-tasks">0</div>
                            <div class="stat-label">任务</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="stat-points">0</div>
                            <div class="stat-label">积分</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="stat-complete">0%</div>
                            <div class="stat-label">完成度</div>
                        </div>
                    </div>
                </div>
                <div class="game-content" id="game-content">
                    <div id="dialogue-area">
                        <div class="dialogue-box">
                            <div class="dialogue-speaker">系统</div>
                            <div class="dialogue-text" id="narrative">你尚未进入任何世界。请先在"世界剧情"中选择或创建一个世界。</div>
                        </div>
                    </div>
                    
                    <div id="choices-wrap"></div>
                </div>
                <div class="game-footer">
                    <div class="action-buttons">
                        <button class="action-btn" id="btn-generate-report">📜</button>
                        <button class="action-btn" id="btn-exit-world">🏠</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 存读档屏幕 -->
        <div id="save-screen" class="screen">
            <div class="screen-header">
                <div class="back-btn" data-back="home-screen">返回</div>
                <div class="screen-title">存读档</div>
                <div></div>
            </div>
            <div class="screen-content">
                <div class="settings-section">
                    <div class="settings-item" id="save-game-btn" style="cursor: pointer;">
                        <div class="settings-label">💾 保存当前进度</div>
                        <div class="settings-value">></div>
                    </div>
                    <div class="settings-item" id="load-game-btn" style="cursor: pointer;">
                        <div class="settings-label">📂 读取上次进度</div>
                        <div class="settings-value">></div>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-item" id="delete-save-btn" style="color: #ff3b30; cursor: pointer;">
                        <div class="settings-label">🗑️ 删除本地存档</div>
                        <div class="settings-value">></div>
                    </div>
                </div>
                <p id="save-status" style="text-align: center; color: #8e8e93; margin-top: 20px; text-align: center;"></p>
            </div>
        </div>
        
        <!-- 世界剧情屏幕 -->
        <div id="worlds-screen" class="screen">
            <div class="screen-header">
                <div class="back-btn" data-back="home-screen">返回</div>
                <div class="screen-title">世界选择</div>
                <div></div>
            </div>
            <div class="screen-content">
                <div style="display:flex;gap:8px;margin-bottom:10px;">
                    <button class="btn primary" id="btn-new-world">新建世界</button>
                    <button class="btn ghost" id="btn-random-world">随机世界</button>
                    <button class="btn ghost" id="btn-custom-world">自定义世界</button>
                </div>

                <div class="small-muted">可选世界（点击以查看并生成任务简报）</div>
                <div class="world-list" id="world-list"></div>
                <div class="small-muted">已保存世界将显示在此处，穿越后会加入"已完成世界"。</div>
            </div>
        </div>
        
        <!-- 个人信息屏幕 -->
        <div id="profile-screen" class="screen">
            <div class="screen-header">
                <div class="back-btn" data-back="home-screen">返回</div>
                <div class="screen-title">个人信息</div>
                <div></div>
            </div>
            <div class="screen-content">
                <div class="profile">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <div style="font-weight:700;font-size:18px;" id="profile-name">宿主</div>
                            <div class="small-muted" id="profile-desc">毒舌系统 • 宿主搭档</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-weight:800;font-size:20px;" id="profile-points">0</div>
                            <div class="small-muted">积分</div>
                        </div>
                    </div>
                    <div style="margin-top:10px;">
                        <div class="small-muted">已完成世界</div>
                        <div id="completed-worlds" style="margin-top:8px;"></div>
                    </div>
                </div>

                <div class="leaderboard" id="leaderboard">
                    <div style="font-weight:700;margin-bottom:8px;">排行榜</div>
                    <div id="leaderboard-list"></div>
                </div>
            </div>
        </div>
        
        <!-- 结算报告屏幕 -->
        <div id="report-screen" class="screen">
            <div class="screen-header">
                <div class="back-btn" data-back="home-screen">返回</div>
                <div class="screen-title">结算报告</div>
                <div></div>
            </div>
            <div class="screen-content" id="report-content" style="overflow:auto;padding:18px;"></div>
        </div>
        
        <!-- 隐藏的文件输入框用于导入角色卡 -->
        <input type="file" id="import-card-input" accept=".json,.png">
        
        <!-- 角色详情模态框 -->
        <div id="character-detail-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">角色详情</div>
                    <div class="modal-close">&times;</div>
                </div>
                <div class="modal-body">
                    <div class="character-detail">
                        <div class="character-detail-avatar" id="detail-avatar">👤</div>
                        <div class="character-detail-name" id="detail-name">角色名</div>
                        <div class="character-detail-desc" id="detail-desc">角色描述</div>
                        <div class="character-detail-info">
                            <h3>角色信息</h3>
                            <p id="detail-info">这里是角色的详细信息...</p>
                        </div>
                        <button class="form-button form-button-secondary" id="edit-character-btn">编辑角色</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 创建/编辑角色模态框 -->
        <div id="create-character-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title" id="create-character-title">创建新角色</div>
                    <div class="modal-close">&times;</div>
                </div>
                <div class="modal-body">
                    <form class="create-character-form" id="character-form">
                        <div class="form-group">
                            <label for="character-name">角色名称</label>
                            <input type="text" id="character-name" placeholder="请输入角色名称">
                        </div>
                        <div class="form-group">
                            <label for="character-desc">角色描述</label>
                            <input type="text" id="character-desc" placeholder="请输入角色描述">
                        </div>
                        <div class="form-group">
                            <label for="character-avatar">角色头像 (emoji)</label>
                            <input type="text" id="character-avatar" placeholder="例如: 👤">
                        </div>
                        <div class="form-group">
                            <label for="character-info">角色详细信息</label>
                            <textarea id="character-info" placeholder="请输入角色的详细信息..." rows="4"></textarea>
                        </div>
                        <div class="form-row">
                            <button type="button" class="form-button form-button-secondary" id="import-character-btn">导入角色卡</button>
                            <button type="submit" class="form-button" id="save-character-btn">保存角色</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- 世界创建 / 任务简报 Modal -->
        <div id="world-modal" class="modal" aria-hidden="true">
            <div class="modal-header">世界生成器</div>
            <div class="modal-body">
                <div style="display:flex;gap:8px;margin-bottom:8px;">
                    <input id="world-name-input" placeholder="世界名称（示例：废弃医院）" style="flex:1;padding:8px;border:1px solid #ddd;border-radius:8px;">
                    <select id="world-tag-select" style="padding:8px;border:1px solid #ddd;border-radius:8px;">
                        <option value="校园">校园</option>
                        <option value="都市">都市</option>
                        <option value="幻想">幻想</option>
                        <option value="悬疑">悬疑</option>
                        <option value="奇幻">奇幻</option>
                    </select>
                </div>
                <div>
                    <label style="font-weight:600;font-size:13px;">世界简述（可为空，随机生成时会自动填充）</label>
                    <textarea id="world-desc-input" placeholder="输入世界背景设定..." style="width:100%;min-height:80px;padding:8px;border:1px solid #ddd;border-radius:8px;"></textarea>
                </div>

                <div style="margin-top:12px;">
                    <div style="font-weight:600;">任务简报预览</div>
                    <div id="brief-preview" style="margin-top:8px;padding:10px;border-radius:8px;border:1px dashed #ddd;background:#fafafa;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn ghost" id="modal-cancel">取消</button>
                <button class="btn primary" id="modal-create">生成并保存</button>
            </div>
        </div>
    </div>

    <script>
        // -------------------- 初始数据 & 持久化 --------------------
        const storageKey = 'ez_game_v1';
        const defaultState = {
            playerName: '宿主',
            playerPoints: 1250,         // 默认积分
            worlds: [                   // 预置几个示例世界
                { id: uid(), name: '校园怪谈夜', tag: '校园', desc: '七号教学楼的哭声，学生会长失踪的秘密...', createdAt: Date.now() },
                { id: uid(), name: '废弃医院探索', tag: '悬疑', desc: '幽暗走廊与红光的房间，旧报纸上写着"别进去"...', createdAt: Date.now() }
            ],
            completedWorlds: [],
            leaderboard: [
                { name: '丘聿', points: 5080 }, { name: '玩家A', points: 3600 }, { name: '玩家B', points: 1850 }
            ],
            characters: [
                { 
                    id: 1, 
                    name: "易知扬", 
                    desc: "幽默开朗的解语花", 
                    avatar: "🐑",
                    info: "新闻社社长，擅长收集情报和洞察人心。表面幽默开朗，实则心思缜密，是解开学院谜团的关键人物。"
                },
                { 
                    id: 2, 
                    name: "许昼", 
                    desc: "清冷早熟的掌控者", 
                    avatar: "🌙",
                    info: "失踪的学生会长，拥有超乎年龄的成熟和掌控力。表面清冷疏离，实则内心温柔，对学院有着深厚的感情。"
                },
                { 
                    id: 3, 
                    name: "顾渝舟", 
                    desc: "自信骄傲的掌控者", 
                    avatar: "🐺",
                    info: "学院的风云人物，自信骄傲，拥有强大的领导力和决断力。看似冷漠，实则对认可的人极为保护。"
                },
                { 
                    id: 4, 
                    name: "李术零", 
                    desc: "外冷内热的痞帅帅哥", 
                    avatar: "❄️",
                    info: "表面玩世不恭的痞帅学长，实则内心温暖，擅长格斗和侦查。是调查七号教学楼的重要帮手。"
                },
                { 
                    id: 5, 
                    name: "齐司礼", 
                    desc: "嘴硬心软的导师", 
                    avatar: "🦊",
                    info: "学院的心理学导师，表面严厉嘴硬，实则关心每一位学生。拥有丰富的心理学知识，能帮助分析案件。"
                },
                { 
                    id: 6, 
                    name: "顾时夜", 
                    desc: "隐忍克制的守护者", 
                    avatar: "🌌",
                    info: "学院的保安队长，沉默寡言但观察力极强。对学院的安全负有强烈责任感，是值得信赖的盟友。"
                }
            ],
            wallpapers: [
                { id: 1, name: "默认", url: "linear-gradient(135deg, #667eea 0%, #764ba2 100%)" },
                { id: 2, name: "星空", url: "linear-gradient(135deg, #0c2461 0%, #1e3799 100%)" },
                { id: 3, name: "森林", url: "linear-gradient(135deg, #2d5a27 0%, #4a7c59 100%)" },
                { id: 4, name: "沙漠", url: "linear-gradient(135deg, #d35400 0%, #f39c12 100%)" },
                { id: 5, name: "海洋", url: "linear-gradient(135deg, #0984e3 0%, #74b9ff 100%)" },
                { id: 6, name: "城市", url: "linear-gradient(135deg, #2d3436 0%, #636e72 100%)" }
            ],
            currentWallpaper: 1,
            editingCharacterId: null
        };

        let state = loadState();

        // -------------------- DOM 快捷 --------------------
        const screens = document.querySelectorAll('.screen');
        function showScreen(id){
            screens.forEach(s => s.id === id ? s.classList.add('active') : s.classList.remove('active'));
        }

        // 导航事件绑定
        document.querySelectorAll('.app-icon[data-screen]').forEach(el=>{
            el.addEventListener('click', ()=> showScreen(el.dataset.screen));
        });
        document.querySelectorAll('.back-btn').forEach(b=>b.addEventListener('click', e=>{
            const back = e.currentTarget.dataset.back || 'home-screen';
            showScreen(back);
        }));

        // 状态栏时间 & 积分显示
        function updateTime(){
            const now = new Date();
            const t = now.toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'});
            document.getElementById('status-time').textContent = t;
            document.getElementById('main-time').textContent = t;
        }
        setInterval(updateTime,60000); updateTime();

        function updatePointsUI(){
            document.getElementById('status-points').textContent = `积分: ${state.playerPoints}`;
            document.getElementById('profile-points').textContent = state.playerPoints;
            document.getElementById('stat-points').textContent = state.playerPoints;
        }
        updatePointsUI();

        // -------------------- 角色库功能 --------------------
        function renderCharacters(){
            const characterGrid = document.querySelector('.character-grid');
            characterGrid.innerHTML = '';
            
            state.characters.forEach(character => {
                const characterCard = document.createElement('div');
                characterCard.className = 'character-card';
                characterCard.dataset.id = character.id;
                characterCard.innerHTML = `
                    <div class="character-avatar">${character.avatar}</div>
                    <div class="character-info">
                        <div class="character-name">${character.name}</div>
                        <div class="character-desc">${character.desc}</div>
                    </div>
                `;
                characterGrid.appendChild(characterCard);
            });
        }

        // 显示角色详情
        function showCharacterDetail(characterId) {
            const character = state.characters.find(c => c.id === characterId);
            if (!character) return;
            
            // 填充角色详情
            document.getElementById('detail-avatar').textContent = character.avatar;
            document.getElementById('detail-name').textContent = character.name;
            document.getElementById('detail-desc').textContent = character.desc;
            document.getElementById('detail-info').textContent = character.info;
            
            // 设置编辑按钮
            document.getElementById('edit-character-btn').onclick = () => {
                editCharacter(characterId);
                document.getElementById('character-detail-modal').classList.remove('active');
            };
            
            // 显示模态框
            document.getElementById('character-detail-modal').classList.add('active');
        }
        
        // 编辑角色
        function editCharacter(characterId) {
            const character = state.characters.find(c => c.id === characterId);
            if (!character) return;
            
            // 设置表单标题
            document.getElementById('create-character-title').textContent = '编辑角色';
            
            // 填充表单数据
            document.getElementById('character-name').value = character.name;
            document.getElementById('character-desc').value = character.desc;
            document.getElementById('character-avatar').value = character.avatar;
            document.getElementById('character-info').value = character.info;
            
            // 设置编辑模式
            state.editingCharacterId = characterId;
            
            // 显示创建角色模态框
            document.getElementById('create-character-modal').classList.add('active');
        }
        
        // 创建新角色
        function createCharacter() {
            // 重置表单
            document.getElementById('character-form').reset();
            
            // 设置表单标题
            document.getElementById('create-character-title').textContent = '创建新角色';
            
            // 设置编辑模式为null（创建模式）
            state.editingCharacterId = null;
            
            // 显示创建角色模态框
            document.getElementById('create-character-modal').classList.add('active');
        }
        
        // 保存角色
        function saveCharacter(formData) {
            if (state.editingCharacterId) {
                // 编辑模式
                const character = state.characters.find(c => c.id === state.editingCharacterId);
                if (character) {
                    character.name = formData.name;
                    character.desc = formData.desc;
                    character.avatar = formData.avatar;
                    character.info = formData.info;
                }
            } else {
                // 创建模式
                const newCharacter = {
                    id: Math.max(...state.characters.map(c => c.id)) + 1,
                    name: formData.name,
                    desc: formData.desc,
                    avatar: formData.avatar,
                    info: formData.info
                };
                state.characters.push(newCharacter);
            }
            
            // 重新渲染角色库
            renderCharacters();
            
            // 关闭模态框
            document.getElementById('create-character-modal').classList.remove('active');
        }

        // -------------------- 壁纸功能 --------------------
        function renderWallpapers() {
            const wallpaperGrid = document.querySelector('.wallpaper-grid');
            wallpaperGrid.innerHTML = '';
            
            state.wallpapers.forEach(wallpaper => {
                const wallpaperItem = document.createElement('div');
                wallpaperItem.className = `wallpaper-item ${wallpaper.id === state.currentWallpaper ? 'active' : ''}`;
                wallpaperItem.dataset.id = wallpaper.id;
                wallpaperItem.innerHTML = `
                    <div class="wallpaper-preview" style="background: ${wallpaper.url}"></div>
                `;
                wallpaperGrid.appendChild(wallpaperItem);
            });
        }
        
        // 设置壁纸
        function setWallpaper(wallpaperId) {
            const wallpaper = state.wallpapers.find(w => w.id === wallpaperId);
            if (wallpaper) {
                document.getElementById('home-screen').style.background = wallpaper.url;
                state.currentWallpaper = wallpaperId;
                
                // 更新壁纸选择界面中的活动状态
                document.querySelectorAll('.wallpaper-item').forEach(item => {
                    item.classList.remove('active');
                    if (parseInt(item.dataset.id) === wallpaperId) {
                        item.classList.add('active');
                    }
                });
            }
        }

        // -------------------- world 列表渲染 & 操作 --------------------
        const worldListEl = document.getElementById('world-list');
        function renderWorldList(){
            worldListEl.innerHTML = '';
            state.worlds.forEach(w=>{
                const el = document.createElement('div');
                el.className = 'world-item';
                el.innerHTML = `
                    <div>
                        <div style="font-weight:700">${escapeHtml(w.name)}</div>
                        <div class="small-muted">${escapeHtml(w.tag)} • ${new Date(w.createdAt).toLocaleDateString()}</div>
                    </div>
                    <div style="display:flex;flex-direction:column;gap:6px;">
                        <button class="btn ghost btn-preview" data-id="${w.id}">简报</button>
                        <button class="btn primary btn-enter" data-id="${w.id}">穿越</button>
                    </div>
                `;
                worldListEl.appendChild(el);
            });

            // 绑定按钮
            document.querySelectorAll('.btn-preview').forEach(b=>{
                b.addEventListener('click', ()=> {
                    const id = b.dataset.id;
                    const w = state.worlds.find(x=>x.id===id);
                    if(w) showBriefPreview(w);
                });
            });
            document.querySelectorAll('.btn-enter').forEach(b=>{
                b.addEventListener('click', ()=> {
                    const id = b.dataset.id;
                    const w = state.worlds.find(x=>x.id===id);
                    if(w) enterWorld(w);
                });
            });
        }
        renderWorldList();

        // -------------------- world modal (新建/自定义/随机) --------------------
        const worldModal = document.getElementById('world-modal');
        const nameInput = document.getElementById('world-name-input');
        const descInput = document.getElementById('world-desc-input');
        const tagSelect = document.getElementById('world-tag-select');
        const briefPreview = document.getElementById('brief-preview');
        
        document.getElementById('btn-new-world').addEventListener('click', ()=>{
            nameInput.value = '';
            descInput.value = '';
            tagSelect.value = '校园';
            briefPreview.innerHTML = '填写信息后点击 生成并保存';
            worldModal.classList.add('visible');
        });
        
        document.getElementById('btn-custom-world').addEventListener('click', ()=>{
            nameInput.value = '';
            descInput.value = '';
            tagSelect.value = '都市';
            briefPreview.innerHTML = '自定义世界，支持手动输入世界简述。';
            worldModal.classList.add('visible');
        });
        
        document.getElementById('btn-random-world').addEventListener('click', ()=>{
            // 随机生成一个世界（基于空白16 的世界观风格）
            const templates = [
                {name:'失落图书馆的低语', tag:'悬疑', desc:'尘封书页中夹着一封写给"许昼"的信，书页会在夜里翻动。'},
                {name:'午夜社团的秘密', tag:'校园', desc:'一个仅在夜里活动的神秘社团，成员名单存在缺失。'},
                {name:'海边遗失的誓言', tag:'都市', desc:'潮水卷起一枚刻字戒指，戒指背后和一段未完成的承诺。'},
                {name:'异界游乐园的笑声', tag:'幻想', desc:'过山车轨道连接着另一个世界，笑声中藏着人心的执念。'}
            ];
            const pick = templates[Math.floor(Math.random()*templates.length)];
            nameInput.value = pick.name;
            tagSelect.value = pick.tag;
            descInput.value = pick.desc;
            // 生成预览
            briefPreview.innerHTML = generateBrief({name:pick.name,tag:pick.tag,desc:pick.desc});
            worldModal.classList.add('visible');
        });

        document.getElementById('modal-cancel').addEventListener('click', ()=> worldModal.classList.remove('visible'));
        document.getElementById('modal-create').addEventListener('click', ()=>{
            const name = nameInput.value.trim() || ('世界-' + Math.floor(Math.random()*9000+1000));
            const tag = tagSelect.value;
            const desc = descInput.value.trim() || '';
            const w = { id: uid(), name, tag, desc, createdAt: Date.now() };
            // 如果 desc 为空，自动生成符合世界观的简报/背景
            if(!w.desc) w.desc = autoGenerateDesc(w.name, w.tag);
            state.worlds.unshift(w);
            saveState();
            renderWorldList();
            worldModal.classList.remove('visible');
        });

        // 预览随输入实时更新
        [nameInput,descInput,tagSelect].forEach(el=>{
            el.addEventListener('input', ()=>{
                const n = nameInput.value.trim() || '世界名称示例';
                const t = tagSelect.value;
                const d = descInput.value.trim();
                briefPreview.innerHTML = generateBrief({name:n,tag:t,desc:d});
            });
        });

        // -------------------- show brief preview & enter world --------------------
        function showBriefPreview(w){
            // 使用 generateBrief 并弹窗展示
            const brief = generateBrief(w);
            // 简单 modal show（复用 world-modal）
            nameInput.value = w.name;
            tagSelect.value = w.tag;
            descInput.value = w.desc;
            briefPreview.innerHTML = brief;
            worldModal.classList.add('visible');
        }

        // 进入世界（穿越）
        function enterWorld(w){
            // 把世界载入到 game-screen 中（显示任务简报并给出选项）
            document.getElementById('game-screen-title').textContent = w.name;
            const narrative = `
                <div class="dialogue-box">
                    <div class="dialogue-speaker">系统</div>
                    <div class="dialogue-text">载入世界：${escapeHtml(w.name)} — ${escapeHtml(w.tag)}</div>
                </div>
                <div class="dialogue-box">
                    <div class="dialogue-speaker">系统</div>
                    <div class="dialogue-text">${escapeHtml(w.desc)}</div>
                </div>
                <div class="dialogue-box">
                    <div class="dialogue-speaker">任务</div>
                    <div class="dialogue-text">${generateShortTasks(w)}</div>
                </div>
            `;
            document.getElementById('dialogue-area').innerHTML = narrative;
            // choices
            const choicesWrap = document.getElementById('choices-wrap');
            choicesWrap.innerHTML = '';
            const btns = [
                {txt:'执行主线任务',fn:()=> performTask(w,'main')},
                {txt:'查看人物档案',fn:()=> performTask(w,'inspect')},
                {txt:'使用积分购买情报',fn:()=> openShopForInfo(w)}
            ];
            btns.forEach(b=>{
                const el = document.createElement('button');
                el.className = 'choice-btn';
                el.textContent = b.txt;
                el.addEventListener('click', b.fn);
                choicesWrap.appendChild(el);
            });

            showScreen('game-screen');
        }

        // 执行任务（示例）
        function performTask(world,type){
            appendNarrative(`系统: 你选择了 ${type === 'main' ? '执行主线' : '查看'}。系统正在评估...`);
            // 简单结果逻辑：随机成功/失败
            const success = Math.random() > 0.25;
            if(success){
                appendNarrative(`系统: 任务进行顺利，获得积分 +${Math.floor(Math.random()*800+200)}。`);
                const gain = Math.floor(Math.random()*800+200);
                state.playerPoints += gain;
                // 完成世界（加入 completed）
                if(!state.completedWorlds.find(w=>w.id===world.id)) state.completedWorlds.push({id:world.id,name:world.name,earned:gain,completedAt:Date.now()});
                // 同步排行榜（把当前宿主写入排行榜）
                updateLeaderboard(state.playerName, state.playerPoints);
            } else {
                appendNarrative(`系统: 出了些麻烦。你被迫撤退，未能完成主线。`);
            }
            saveState();
            updatePointsUI();
            renderCompletedWorlds();
        }

        // 查看商店购买情报（直接打开商城并定位 info 商品）
        function openShopForInfo(world){
            showScreen('shop-screen');
            // 小提示 — 可扩展：定位到某个商品
            alert('商城已打开，使用积分购买情报道具（示例）');
        }

        // 生成短任务（A/B/C）基于 空白16 的"剧情推进保障协议"风格
        function generateShortTasks(world){
            const opts = [
                'A. 前往场景探索线索并记录环境',
                'B. 接触关键NPC并获取对话情报',
                'C. 使用系统情报（花费积分）直接打开密码箱'
            ];
            return `当前任务（主线）: 找出导致执念的关键事件。\n可选行动：\n${opts.join('\n')}`;
        }

        // 追加叙事
        function appendNarrative(text){
            const wrap = document.getElementById('dialogue-area');
            const el = document.createElement('div');
            el.className = 'dialogue-box';
            el.innerHTML = `<div class="dialogue-speaker">系统</div><div class="dialogue-text">${escapeHtml(text)}</div>`;
            wrap.appendChild(el);
            // 自动滚动
            wrap.parentElement.scrollTop = wrap.parentElement.scrollHeight;
        }

        // -------------------- completed worlds & profile --------------------
        function renderCompletedWorlds(){
            const el = document.getElementById('completed-worlds');
            el.innerHTML = '';
            if(!state.completedWorlds.length) el.innerHTML = '<div class="small-muted">暂无已完成世界</div>';
            state.completedWorlds.forEach(w=>{
                const div = document.createElement('div');
                div.style.padding='8px 0';
                div.innerHTML = `<div style="font-weight:600">${escapeHtml(w.name)}</div><div class="small-muted">积分 +${w.earned} • ${new Date(w.completedAt).toLocaleString()}</div>`;
                el.appendChild(div);
            });
        }
        renderCompletedWorlds();

        // -------------------- 商城实现 --------------------
        const shopProducts = [
            { id: 'p1', name:'记忆水晶 - 恢复角色记忆', price:500, desc:'恢复原主记忆片段，便于推进任务。'},
            { id: 'p2', name:'时空之钥 - 解锁新剧情', price:800, desc:'解锁隐藏支线或新区域。'},
            { id: 'p3', name:'NPC情报 - 获取角色信息', price:300, desc:'购买NPC详细信息。'},
            { id: 'p4', name:'直播票 - 提升人气值', price:200, desc:'在直播中获得临时人气加成。'}
        ];

        function renderShop(){
            const parent = document.getElementById('shop-products');
            parent.innerHTML = '';
            shopProducts.forEach(p=>{
                const box = document.createElement('div');
                box.className = 'shop-product';
                box.innerHTML = `<div style="font-weight:700">${escapeHtml(p.name)}</div>
                    <div class="small-muted" style="margin-top:6px;">${escapeHtml(p.desc)}</div>
                    <div class="shop-product-price">积分 ${p.price}</div>
                    <div style="margin-top:8px;"><button class="shop-product-buy btn-buy" data-id="${p.id}">购买</button></div>
                `;
                parent.appendChild(box);
            });

            document.querySelectorAll('.btn-buy').forEach(b=>{
                b.addEventListener('click', ()=>{
                    const pid = b.dataset.id;
                    const prod = shopProducts.find(x=>x.id===pid);
                    if(!prod) return;
                    if(state.playerPoints >= prod.price){
                        if(confirm(`确认花费 ${prod.price} 积分购买「${prod.name}」？`)){
                            state.playerPoints -= prod.price;
                            saveState();
                            updatePointsUI();
                            // 购买后效果示例：如果是情报，弹窗简单展示（可扩展为真实道具）
                            alert(`购买成功：${prod.name}\n（示例效果：你获得了 ${prod.name}）`);
                            // 如果购买了情报，自动追加一个小 narrative
                            appendNarrative(`系统: 已交付道具「${prod.name}」，请在世界中使用。`);
                        }
                    } else {
                        alert('积分不足');
                    }
                });
            });
        }
        renderShop();

        // -------------------- 报告生成功能 --------------------
        document.getElementById('btn-generate-report').addEventListener('click', ()=>{
            const html = generateReportSample();
            document.getElementById('report-content').innerHTML = html;
            showScreen('report-screen');
        });

        // 生成结算报告（简单 HTML 片段）
        function generateReportSample(){
            // 参考空白16 的报告内容结构与用词（复用示例数据）
            const top = `
                <h2 style="text-align:center;color:#6b705c;margin-top:0;">世界任务结算报告</h2>
                <div class="report-container">
                    <p><strong>世界代号:</strong> BG-${Math.floor(Math.random()*900+100)}</p>
                    <p><strong>任务用时:</strong> ${Math.floor(Math.random()*10)+1}天 ${Math.floor(Math.random()*23)}小时${Math.floor(Math.random()*60)}分钟</p>
                    <p><strong>执行者:</strong> ${escapeHtml(state.playerName)}</p>
                    <hr>
                    <h3>任务完成情况</h3>
                    <ul>
                        <li><strong>主线任务:</strong> <span class="completed">已完成</span></li>
                        <li><strong>支线任务:</strong> <span class="not-completed">部分完成</span></li>
                    </ul>
                    <hr>
                    <h3>关键数据</h3>
                    <p><strong>最高好感度NPC:</strong> 许昼 (95)</p>
                    <p><strong>世界线修正度:</strong> ${Math.floor(Math.random()*40)+60}%</p>
                    <p><strong>最终积分结算:</strong> +${Math.floor(Math.random()*2000+500)}</p>
                    <hr>
                    <h3>系统评价</h3>
                    <div style="background:#f3f3f3;padding:10px;border-left:4px solid #8a9a5b;">
                        "恭喜宿主，本次任务的愚蠢操作指数控制在了'令人费解'而非'灾难现场'。总体表现还能看。"
                    </div>
                </div>
            `;
            return top;
        }

        // -------------------- leaderboard 相关 --------------------
        function renderLeaderboard(){
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = '';
            const sorted = state.leaderboard.slice().sort((a,b)=>b.points-a.points);
            sorted.forEach((p,idx)=>{
                const div = document.createElement('div');
                div.style.display='flex';
                div.style.justifyContent='space-between';
                div.style.padding='6px 0';
                div.innerHTML = `<div>${idx+1}. ${escapeHtml(p.name)}</div><div style="font-weight:700">${p.points}</div>`;
                list.appendChild(div);
            });
        }
        renderLeaderboard();

        // 更新排行榜（本地）
        function updateLeaderboard(name, points){
            const found = state.leaderboard.find(x=>x.name===name);
            if(found){ found.points = points; } else { state.leaderboard.push({name,points}); }
            saveState();
            renderLeaderboard();
        }

        // -------------------- 辅助函数 --------------------
        function generateBrief(w){
            // 根据空白16 的设定与报告样式生成一个任务简报（HTML 字符串）
            const title = `<div style="font-weight:700;margin-bottom:6px;">世界：${escapeHtml(w.name)} (${escapeHtml(w.tag)})</div>`;
            const desc = `<div class="small-muted">${escapeHtml(w.desc || autoGenerateDesc(w.name,w.tag))}</div>`;
            const tasks = `<div style="margin-top:8px;"><strong>任务：</strong> 接收原主记忆，找出执念根源并完成遗愿。</div>`;
            const hint = `<div class="small-muted" style="margin-top:6px;">提示：系统将在5分钟无操作时给出2-3个可执行选项（剧情推进保障协议）。</div>`;
            return title + desc + tasks + hint;
        }
        
        function autoGenerateDesc(name,tag){
            const base = {
                '校园':'破旧教学楼深夜传来哭声，学生会长的记忆像书页一样破碎。',
                '悬疑':'昏暗的灯光下，总有脚步声从远处传来，墙上写着"别回头"。',
                '都市':'城市的霓虹背后藏着一段被遗忘的誓言，潮水会把秘密冲上岸。',
                '奇幻':'彩色的霓虹如流星落下，现实与梦境在午夜交错。',
                '幻想':'游乐园轨道连接着异界，笑声中隐含执念的碎片。'
            };
            return base[tag] || `这是一个名为${name}的世界，埋藏着一个未完的执念。`;
        }
        
        function uid(){ return 'w_'+Math.random().toString(36).slice(2,9); }
        
        function escapeHtml(s){ 
            if(!s) return ''; 
            return String(s).replace(/[&<>"']/g, c=>({ 
                '&':'&amp;',
                '<':'&lt;',
                '>':'&gt;',
                '"':'&quot;',
                "'":'&#39;' 
            })[c]); 
        }

        // -------------------- state 保存 / 加载 --------------------
        function saveState(){ 
            localStorage.setItem(storageKey, JSON.stringify(state)); 
        }
        
        function loadState(){
            try {
                const raw = localStorage.getItem(storageKey);
                if(raw) return JSON.parse(raw);
                localStorage.setItem(storageKey, JSON.stringify(defaultState));
                return JSON.parse(JSON.stringify(defaultState));
            } catch(e){
                console.error('load state err', e);
                return JSON.parse(JSON.stringify(defaultState));
            }
        }

        // -------------------- 事件监听器设置 --------------------
        function setupEventListeners() {
            // 角色卡片点击事件
            document.querySelector('.character-grid').addEventListener('click', function(e) {
                const characterCard = e.target.closest('.character-card');
                if (characterCard) {
                    const characterId = parseInt(characterCard.dataset.id);
                    showCharacterDetail(characterId);
                }
            });
            
            // 添加角色按钮点击事件
            document.getElementById('add-character-btn').addEventListener('click', () => {
                createCharacter();
            });
            
            // 角色表单提交事件
            document.getElementById('character-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = {
                    name: document.getElementById('character-name').value.trim(),
                    desc: document.getElementById('character-desc').value.trim(),
                    avatar: document.getElementById('character-avatar').value.trim(),
                    info: document.getElementById('character-info').value.trim()
                };
                
                if (!formData.name) {
                    alert('请输入角色名称');
                    return;
                }
                
                if (!formData.desc) {
                    alert('请输入角色描述');
                    return;
                }
                
                if (!formData.avatar) {
                    alert('请输入角色头像(emoji)');
                    return;
                }
                
                saveCharacter(formData);
            });
            
            // 壁纸选择事件
            document.querySelector('.wallpaper-grid').addEventListener('click', function(e) {
                const wallpaperItem = e.target.closest('.wallpaper-item');
                if (wallpaperItem) {
                    const wallpaperId = parseInt(wallpaperItem.dataset.id);
                    setWallpaper(wallpaperId);
                }
            });
            
            // 设置项点击事件
            document.querySelectorAll('.settings-item').forEach(item => {
                if (item.dataset.screen) {
                    item.addEventListener('click', function() {
                        showScreen(this.dataset.screen);
                    });
                }
            });
            
            // 模态框关闭事件
            document.querySelectorAll('.modal-close').forEach(closeBtn => {
                closeBtn.addEventListener('click', function() {
                    this.closest('.modal').classList.remove('active');
                });
            });
            
            // 点击模态框外部关闭
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('active');
                    }
                });
            });
            
            // 论坛发帖按钮点击事件
            document.querySelector('.forum-new-post').addEventListener('click', function() {
                alert('发帖功能开发中...');
            });
            
            // 退出世界按钮
            document.getElementById('btn-exit-world').addEventListener('click', ()=>{
                // 返回系统空间（示例结算时会加入 completedWorlds）
                appendNarrative('系统: 返回系统空间。任务已结算（示例）。');
                showScreen('home-screen');
            });
        }

        // -------------------- 初始化 --------------------
        function initGame() {
            // 更新状态栏时间
            updateTime();
            setInterval(updateTime, 60000);
            
            // 设置当前壁纸
            setWallpaper(state.currentWallpaper);
            
            // 渲染角色库
            renderCharacters();
            
            // 渲染壁纸选择
            renderWallpapers();
            
            // 设置事件监听器
            setupEventListeners();
            
            // 更新积分显示
            updatePointsUI();
            
            // 渲染世界列表
            renderWorldList();
            
            // 渲染已完成世界
            renderCompletedWorlds();
            
            // 渲染排行榜
            renderLeaderboard();
        }

        // 页面加载完成后初始化游戏
        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>